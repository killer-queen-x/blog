<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.mini.ma.PostMapper">
    <resultMap id="Home" type="com.example.mini.xx.Post">
        <id column="pid" property="pid"/>
        <result column="title" property="title"/>
        <result column="content" property="content"/>
        <result column="image" property="image"/>
        <result column="time" property="time"/>
        <result column="uid" property="uid"/>
        <collection property="comments" ofType="com.example.mini.xx.Comment">
            <id column="cid" property="cid"/>
            <result column="pid" property="pid"/>
            <result column="puid" property="puid"/>
            <result column="uid" property="uid"/>
            <result column="comment" property="comment"/>
            <result column="ctime" property="ctime"/>
            <result column="pictrue" property="pictrue"/>
        </collection>
        <collection property="replies" ofType="com.example.mini.xx.Reply">
            <id column="rid" property="rid"/>
            <result column="pid" property="pid"/>
            <result column="cid" property="cid"/>
            <result column="uid" property="uid"/>
            <result column="reply" property="reply"/>
            <result column="rtime" property="rtime"/>
        </collection>
        <collection property="users" ofType="com.example.mini.xx.User">
            <id column="uid" property="uid"/>
            <result column="nickname" property="nickname"/>
            <result column="icon" property="icon"/>
            <result column="sign" property="sign"/>
        </collection>
        <collection property="goods" ofType="com.example.mini.xx.Good">
            <id column="gid" property="gid"/>
            <result column="pid" property="pid"/>
            <result column="uid" property="uid"/>
        </collection>
    </resultMap>

<!--    首页-->
    <select id="Home" resultMap="Home">
        select
        p.*,
        c.cid,

        r.rid,
        u.uid,
        u.nickname,
        u.icon,
        g.*

        from post  p
        left  join
         comment  c
         on p.pid=c.pid
         left join
         reply r
         on p.pid=r.pid
         left join
            user u
         on p.uid=u.uid
         left join
            good g
        on g.pid=p.pid
          order by rand()
    </select>
    <select id="Person" resultMap="Home">
        select
        p.*,

        u.uid,
        u.nickname,
        u.icon,
        g.*

        from post  p
        left  join
         comment  c
         on p.pid=c.pid
         left join
         reply r
         on p.pid=r.pid
         left join
            user u
         on p.uid=u.uid
         left join
            good g
            on g.pid=p.pid
         where p.uid=#{uid}
          order by p.pid desc
    </select>
    <resultMap id="Detail" type="com.example.mini.xx.Post">
        <id column="pid" property="pid"/>
        <result column="title" property="title"/>
        <result column="content" property="content"/>
        <result column="image" property="image"/>
        <result column="time" property="time"/>
        <result column="uid" property="uid"/>
        <collection property="users" ofType="com.example.mini.xx.User">
            <id column="uid" property="uid"/>
            <result column="nickname" property="nickname"/>
            <result column="icon" property="icon"/>
        </collection>
    </resultMap>
<!--    详情-->
    <select id="Detail" resultMap="Detail">
        select p.*,u.nickname,u.icon from post p
         left join
          user u
          on p.uid=u.uid
          where pid=#{pid}
    </select>

    <insert id="addPost"  parameterType="com.example.mini.xx.Post">
        insert into post(title,content,image,time,uid) values(#{title},#{content},#{image},#{time},#{uid})
    </insert>

    <delete id="delPost">
        delete from post where pid=#{pid}
    </delete>

    <resultMap id="CommentNotice" type="com.example.mini.xx.Post">
        <id column="pid" property="pid"/>
        <result column="title" property="title"/>
        <result column="image" property="image"/>
        <collection property="comments" ofType="com.example.mini.xx.Comment">
            <id column="cid" property="cid"/>
            <result column="pid" property="pid"/>
            <result column="puid" property="puid"/>
            <result column="uid" property="uid"/>
            <result column="comment" property="comment"/>
            <result column="ctime" property="ctime"/>
            <result column="pictrue" property="pictrue"/>
        </collection>
        <collection property="users" ofType="com.example.mini.xx.User">
            <id column="uid" property="uid"/>
            <result column="nickname" property="nickname"/>
            <result column="icon" property="icon"/>
        </collection>
    </resultMap>

    <select id="CommentNotice" resultMap="CommentNotice">
        SELECT p.pid,p.title,p.image,c.*,u.icon,u.nickname
         from post p
         LEFT JOIN comment c
         ON c.pid=p.pid
         LEFT JOIN user u
         on u.uid=c.uid
         where p.uid=#{uid}
    </select>

</mapper>